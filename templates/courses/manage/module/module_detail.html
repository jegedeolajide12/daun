{% extends parent_template|default:"navbar.html" %}
{% load static %}
{% load course %}
{% block content %}
    <!-- Content -->
    <div class="page-content bg-white">
        <!-- inner page banner -->
        <div class="page-banner ovbl-dark" style="background-image:url({% static 'assets/images/banner/banner2.jpg' %});">
            <div class="container py-5 position-relative ">
                <div class="page-banner-entry">
                    <h1 class="text-white">Topic Details</h1>
				 </div>
            </div>
        </div>
		<!-- Breadcrumb row -->
		<div class="breadcrumb-row">
			<div class="container">
				<ul class="list-inline">
					<li><a href="#">Home</a></li>
					<li>Topic Details</li>
				</ul>
			</div>
		</div>
        <div class="content-block">
            <div class="section-area section-sp1">
                <div class="container py-5">
                    <div class="row g-4">
                        <!-- Left part start -->
                        <div class="col-lg-8 col-xl-8 order-lg-1 order-2">
                            <!-- blog start -->
                            <div class="recent-news blog-lg">
                                <!-- Display Video or Image Content -->
                                {% for content in contents %}
                                    {% if content.item|model_name == 'video' and content.item.file %}
                                        <div class="action-box blog-lg">
                                            <video controls width="100%" class="rounded">
                                                <source src="{{ content.item.file.url }}" type="video/mp4">
                                                Your browser does not support the video tag.
                                            </video>
                                        </div>
                                        <!-- Show Delete Button Only to the Owner -->
                                        {% if content.item.owner == user %}
                                            <form method="post" action="{% url 'course:content_delete' content.id %}">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-danger mt-2">Delete</button>
                                            </form>
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                                <!-- Topic Details -->
                                <div class="info-bx">
                                    
                                    <h5 class="post-title">{{ topic.name|title }}</h5>
                                    <div class="media-post mt-3 text-start">
                                        <ul class="list-inline mb-0">
                                            <li class="list-inline-item"><a href="#"><i class="fa fa-calendar"></i> {{ topic.course.created|date:"M j Y" }}</a></li>
                                            <li class="list-inline-item"><a href="#"><i class="fa fa-comments-o"></i> 10 Comment</a></li>
                                        </ul>
                                    </div>
                                    <p>{{ topic.description|linebreaks }}</p>
                                    <div class="ttr-divider bg-gray"><i class="icon-dot c-square"></i></div>

                                    <!-- Content Upload Buttons -->
                                    <div class="col-12">
                                        <h7>CHOOSE A CONTENT TO UPLOAD</h7>
                                    </div>
                                    <br>
                                    <div class="col-lg-8 col-sm-12 col-md-12">
                                        <a href="{% url 'course:topic_content_create' topic.id 'text' %}" class="btn btn-secondary">TEXT</a>
                                        {% if video_count < 1 %}
                                            <a href="{% url 'course:topic_content_create' topic.id 'video' %}" class="btn btn-secondary">VIDEO</a>
                                        {% else %}
                                            <button class="btn btn-disabled" disabled>Video</button>
                                        {% endif %}
                                        <a href="{% url 'course:topic_content_create' topic.id 'image' %}" class="btn btn-secondary">IMAGES</a>
                                        <a href="{% url 'course:topic_content_create' topic.id 'file' %}" class="btn btn-secondary">FILES</a>
                                    </div>
                                    <div class="ttr-divider bg-gray"><i class="icon-dot c-square"></i></div>

                                    <!-- Social Sharing -->
                                    <h6>SHARE</h6>
                                    <ul class="list-inline contact-social-bx">
                                        <li><a href="#" class="btn outline radius-xl"><i class="fa fa-facebook"></i></a></li>
                                        <li><a href="#" class="btn outline radius-xl"><i class="fa fa-twitter"></i></a></li>
                                        <li><a href="#" class="btn outline radius-xl"><i class="fa fa-linkedin"></i></a></li>
                                        <li><a href="#" class="btn outline radius-xl"><i class="fa fa-google-plus"></i></a></li>
                                    </ul>
                                    <div class="ttr-divider bg-gray"><i class="icon-dot c-square"></i></div>
                                </div>
                            </div>
                            <!-- New Assignments Section -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h4 class="mb-0">Topic Assignments</h4>
                                </div>
                                <div class="card-body">
                                    <div class="list-group">
                                        {% for assignment in assignments %}
                                        <div class="list-group-item">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h5 class="mb-1"><a href="{{ assignment.get_absolute_url }}">{{ assignment.title }}</a> </h5>
                                                    <small class="text-muted">Due: {{ assignment.due_date|date:"M j, Y" }}</small>
                                                </div>
                                                <span class="badge bg-{% if assignment.assignment_task.user_tasks.status == 'submitted' %}info{% elif assignment.status == 'graded' %}success{% elif assignment.status == 'overdue' %}danger{% else %}warning{% endif %}">
                                                    {{ assignment.get_status_display }}
                                                </span>
                                            </div>
                                            <p class="mt-2 mb-0">{{ assignment.description|truncatewords:20 }}</p>
                                            
                                            <!-- Submission Button (conditionally shown) -->
                                            <div class="d-flex justify-content-between align-items-center mt-2">
                                                <small class="text-muted">
                                                    {% if assignment.due_date|date:"U" < now|date:"U" %}
                                                        Due date passed
                                                    {% else %}
                                                        Due in {{ assignment.due_date|timeuntil }}
                                                    {% endif %}
                                                </small>
                                                
                                                {% if user_task and user_task.status != 'submitted' and assignment.due_date|date:"U" > now|date:"U" %}
                                                    <a href="{% url 'course:submit_assignment' course_id=assignment.course.id topic_id=topic.id assignment_id=assignment.id %}" 
                                                    class="btn btn-sm btn-primary">
                                                        <i class="fa fa-paper-plane me-1"></i> Submit
                                                    </a>
                                                {% elif user_task.status == 'submitted' %}
                                                    <span class="badge bg-success">
                                                        <i class="fa fa-check me-1"></i> Submitted
                                                    </span>
                                                {% else %}
                                                    <span class="text-danger small">
                                                        <i class="fa fa-exclamation-circle me-1"></i> Submission closed
                                                    </span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% empty %}
                                        <div class="text-muted">No assignments for this topic</div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>

                            <!-- Comments Section -->
                            <div class="clear" id="comment-list">
                                <div class="comments-area" id="comments">
                                    <h2 class="comments-title">8 Comments</h2>
                                    <div class="clearfix m-b20">
                                        <!-- Comment List -->
                                        <ol class="comment-list">
                                            <!-- Example Comment -->
                                            <li class="comment">
                                                <div class="comment-body">
                                                    <div class="comment-author vcard">
                                                        <img class="avatar photo" src="{% static 'assets/images/testimonials/pic1.jpg' %}" alt="">
                                                        <cite class="fn">John Doe</cite>
                                                        <span class="says">says:</span>
                                                    </div>
                                                    <div class="comment-meta">
                                                        <a href="#">December 02, 2019 at 10:45 am</a>
                                                    </div>
                                                    <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nam vitae neque vitae sapien malesuada aliquet.</p>
                                                    <div class="reply">
                                                        <a href="#" class="comment-reply-link">Reply</a>
                                                    </div>
                                                </div>
                                            </li>
                                            <!-- Repeat for other comments -->
                                        </ol>
                                        <!-- Comment Form -->
                                        <div class="comment-respond" id="respond">
                                            <h4 class="comment-reply-title" id="reply-title">Leave a Reply</h4>
                                            <form class="comment-form" id="commentform" method="post">
                                                <p class="comment-form-author">
                                                    <label for="author">Name <span class="required">*</span></label>
                                                    <input type="text" name="Author" placeholder="Author" id="author">
                                                </p>
                                                <p class="comment-form-email">
                                                    <label for="email">Email <span class="required">*</span></label>
                                                    <input type="text" placeholder="Email" name="email" id="email">
                                                </p>
                                                <p class="comment-form-comment">
                                                    <label for="comment">Comment</label>
                                                    <textarea rows="8" name="comment" placeholder="Comment" id="comment"></textarea>
                                                </p>
                                                <p class="form-submit">
                                                    <input type="submit" value="Submit Comment" class="submit" id="submit" name="submit">
                                                </p>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Left part END -->
                         

                        <!-- Sidebar -->
                        <div class="col-lg-4 col-xl-4 col-md-12 order-lg-2 order-1">
                            <div class="sticky-top" style="top: 80px;">
                                <!-- Learning Materials -->
                                <div class="card border-0 shadow-sm mb-4">
                                    <div class="card-header bg-primary text-white">
                                        <h5 class="mb-0">Learning Materials</h5>
                                    </div>
                                    <div class="card-body">
                                    {% if contents %}
                                        <ul class="list-group list-group-flush">
                                            {% for content in contents %}
                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                <span>{{ content.item.title }}</span>
                                                <span class="badge bg-secondary">
                                                    {{ content.item|model_name|title }}
                                                </span>
                                            </li>
                                            {% endfor %}
                                        </ul>
                                    {% else %}
                                        <p class="text-muted">No learning materials available for this topic.</p>
                                    {% endif %}
                                    </div>
                                </div>

                                <!-- Topic Progress -->
                                <div class="card border-0 mb-4 shadow-sm">
                                    <div class="card-header bg-success text-white">
                                        <h5 class="mb-0">Your Progress</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between mb-1">
                                                <span>Topic Completion</span>
                                                <span>{{ topic_completion_percentage }}%</span>
                                            </div>
                                            <div class="progress" style="height: 8px;">
                                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" 
                                                    role="progressbar" style="width: {{ topic_completion_percentage }}%" 
                                                    aria-valuenow="{{ topic_completion_percenage }}" aria-valuemin="0" aria-valuemax="100">
                                                </div>
                                            </div>
                                        </div>
                                        <dl class="row mb-0">
                                            <dt class="col-6">Completed:</dt>
                                            <dd class="col-6 text-end">{{ completed_topics_count }}/{{ total_topics }} topics</dd>
                                            <dt class="col-6">Assignments:</dt>
                                            <dd class="col-6 text-end">{{ total_completed_assignments }}/{{ assignments|length }} done</dd>
                                            <dt class="col-6">Quizzes:</dt>
                                            <dd class="col-6 text-end">1/2 done</dd>
                                        </dl>
                                    </div>
                                </div>

                                <!-- Upcoming Deadlines -->
                                <div class="card border-0 mb-4 shadow-sm">
                                    <div class="card-header bg-warning text-dark">
                                        <h5 class="mb-0">Upcoming Deadlines</h5>
                                    </div>
                                    <div class="card-body">
                                    {% if assignments %}
                                        <ul class="list-group list-group-flush">
                                            {% for assignment in assignments|slice:":3" %}
                                            <li class="list-group-item">
                                                <div class="d-flex justify-content-between">
                                                    <span>{{ assignment.title }}</span>
                                                    <small class="text-muted">{{ assignment.due_date|date:"M j" }}</small>
                                                </div>
                                            </li>
                                            {% empty %}
                                            <li class="list-group-item text-muted">No upcoming deadlines</li>
                                            {% endfor %}
                                        </ul>
                                    {% else %}
                                        <p class="text-muted">No upcoming deadlines</p>
                                    {% endif %}
                                    </div>
                                </div>

                                <!-- Instructor Info -->
                                <div class="card-body">
                                    <div class="d-flex align-items-start mb-4">
                                        <!-- Image Container -->
                                        <div class="me-3">
                                            <img src="{% if topic.course.owner.profile_picture %}{{ topic.course.owner.profile_picture.url }}{% else %}{% static 'assets/images/empty_profile.jpg' %}{% endif %}"
                                                class="rounded-circle border border-3 border-white shadow-sm"
                                                style="width: 72px; height: 72px; object-fit: cover;"
                                                alt="{{ topic.course.owner.get_full_name }} profile picture">
                                        </div>
                                        
                                        <!-- Instructor Info with Badge -->
                                        <div class="flex-grow-1 position-relative">
                                            <div class="d-flex align-items-center">
                                                <h5 class="mb-0 me-2">{% if topic.course.owner.full_name %}{{ topic.course.owner.full_name }}{% else %} {{ topic.course.owner.username }}{% endif %}</h5>
                                                <!-- Verification badge now next to name -->
                                                <div class="bg-primary rounded-circle p-1 border border-2 border-white" style="width: 20px; height: 20px;">
                                                    <i class="fa fa-check text-white d-flex justify-content-center align-items-center" style="font-size: 0.7rem;"></i>
                                                </div>
                                            </div>
                                            
                                            <p class="text-muted small mb-2">Course Instructor</p>
                                            
                                            <!-- Rating (optional) -->
                                            <div class="d-flex align-items-center mb-2">
                                                <div class="text-warning me-2">
                                                    <i class="fa fa-star"></i>
                                                    <i class="fa fa-star"></i>
                                                    <i class="fa fa-star"></i>
                                                    <i class="fa fa-star"></i>
                                                    <i class="fa fa-star-half-alt"></i>
                                                </div>
                                                <small class="text-muted">4.8 (128 reviews)</small>
                                            </div>
                                            
                                            <!-- Bio -->
                                            <p class="mb-3 text-muted">{{ topic.course.owner.bio|truncatewords:20 }}</p>
                                            
                                            <!-- Contact Buttons with proper spacing -->
                                            <div class="row"> <!-- Use row for proper spacing -->
                                                <div class="col">
                                                    <a href="#" class="btn btn-sm btn-outline-primary rounded-pill px-3 w-100 text-center">
                                                        <i class="fa fa-envelope me-2"></i> Message
                                                    </a>
                                                </div>
                                                <div class="col">
                                                    <a href="#" class="btn btn-sm btn-outline-secondary rounded-pill px-3 w-100 text-center">
                                                        <i class="fa fa-user me-2"></i> Profile
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Sidebar END -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% include "footer.html" %}
{% endblock %}