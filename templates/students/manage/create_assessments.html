{% extends 'user_navbar.html' %}

{% block content %}
<main class="ttr-wrapper">
    <div class="container py-4">
        <div class="card">
            <div class="card-header">
                <h2>Create Assessment</h2>
            </div>
            <div class="card-body">
                <form id="assessmentForm" method="post">
                    {% csrf_token %}
                    
                    {{ form.non_field_errors }}
                    <div class="mb-3">
                        <label for="id_topic" class="form-label">Topic</label>
                        {{ form.topic }}
                        {% if form.topic.errors %}
                            <div class="text-danger">{{ form.topic.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        <label for="id_topic" class="form-label">Points per question</label>
                        {{ form.points }}
                        {% if form.points.errors %}
                            <div class="text-danger">{{ form.points.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        <label for="id_topic" class="form-label">Assessment Due Date</label>
                        {{ form.due_date }}
                        {% if form.due_date.errors %}
                            <div class="text-danger">{{ form.due_date.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        <label for="id_topic" class="form-label">Time Limit</label>
                        {{ form.time_limit }}
                        {% if form.time_limit.errors %}
                            <div class="text-danger">{{ form.time_limit.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="mb-4">
                        <h4>Questions</h4>
                        <div id="questionsContainer" class="mb-3">
                            <!-- Questions will be added here -->
                        </div>
                        <button type="button" id="addQuestionBtn" class="btn btn-outline-primary">
                            <i class="fas fa-plus"></i> Add Question
                        </button>
                        <div id="questionsError" class="text-danger mt-2"></div>
                    </div>
                    <div class="d-flex justify-content-between">
                        <a href="#" class="btn btn-secondary">
                            Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            Create Assessment
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</main>


<script>
document.addEventListener('DOMContentLoaded', function() {
    const questionsContainer = document.getElementById('questionsContainer');
    const addQuestionBtn = document.getElementById('addQuestionBtn');
    let questionCount = 0;

    // Add initial question
    addQuestion();

    addQuestionBtn.addEventListener('click', addQuestion);

    function addQuestion() {
        questionCount++;
        const questionId = `question_${questionCount}`;
        const questionHtml = `
        <div class="card mb-4 question-item" id="${questionId}">
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Question Text</label>
                    <textarea class="form-control question-text" name="questions[${questionCount}][text]" rows="2" required></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Explanation (optional)</label>
                    <textarea class="form-control" name="questions[${questionCount}][explanation]" rows="2"></textarea>
                </div>
                <div>
                    <h5>Options</h5>
                    <div class="options-container mb-2" id="options-for-${questionId}">
                        <!-- Options will be added here -->
                    </div>
                    <button type="button" class="btn btn-outline-secondary btn-sm add-option-btn" data-question-id="${questionId}">
                        <i class="fas fa-plus"></i> Add Option
                    </button>
                </div>
                <button type="button" class="btn btn-sm btn-danger mt-2 remove-question" data-question-id="${questionId}">
                    <i class="fas fa-trash"></i> Remove Question
                </button>
            </div>
        </div>
        `;
        questionsContainer.insertAdjacentHTML('beforeend', questionHtml);

        // Add two initial options for this question
        addOption(questionId, questionCount);
        addOption(questionId, questionCount);

        // Add event listeners
        document.querySelector(`#${questionId} .add-option-btn`).addEventListener('click', function() {
            addOption(questionId, questionCount);
        });
        document.querySelector(`#${questionId} .remove-question`).addEventListener('click', function() {
            document.getElementById(questionId).remove();
        });
    }

    function addOption(questionId, questionIndex) {
        const optionsContainer = document.getElementById(`options-for-${questionId}`);
        const optionCount = optionsContainer.querySelectorAll('.option-item').length + 1;
        const optionId = `${questionId}_option_${optionCount}`;
        const optionHtml = `
        <div class="card mb-2 option-item" id="${optionId}">
            <div class="card-body d-flex align-items-center">
                <input type="text" class="form-control option-text me-2" name="questions[${questionIndex}][options][${optionCount}][text]" placeholder="Option text" required>
                <div class="form-check form-switch me-2">
                    <input class="form-check-input is-correct-checkbox" type="checkbox" name="questions[${questionIndex}][options][${optionCount}][is_correct]" value="true">
                    <label class="form-check-label">Correct</label>
                </div>
                <button type="button" class="btn btn-sm btn-danger remove-option" data-option-id="${optionId}">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
        `;
        optionsContainer.insertAdjacentHTML('beforeend', optionHtml);

        // Remove option handler
        document.querySelector(`#${optionId} .remove-option`).addEventListener('click', function() {
            if (optionsContainer.querySelectorAll('.option-item').length <= 2) {
                alert('At least 2 options are required per question');
                return;
            }
            document.getElementById(optionId).remove();
        });
    }
});
</script>
{% endblock %}