{% extends 'user_navbar.html' %}

{% block content %}
<main class="ttr-wrapper">
    <div class="container py-4">
        <div class="card">
            <div class="card-header">
                <h2>Create Assessment</h2>
            </div>
            <div class="card-body">
                <form id="assessmentForm" method="post">
                    {% csrf_token %}
                    
                    {{ form.non_field_errors }}
                    
                    <div class="row mb-4">
                        <div class="col-md-12">
                            {{ form.question.label_tag }}
                            {{ form.question }}
                            <div class="invalid-feedback">{{ form.question.errors }}</div>
                        </div>
                    </div>
                    
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            {{ form.points.label_tag }}
                            {{ form.points }}
                            <div class="invalid-feedback">{{ form.points.errors }}</div>
                        </div>
                        <div class="col-md-4">
                            {{ form.difficulty.label_tag }}
                            {{ form.difficulty }}
                            <div class="invalid-feedback">{{ form.difficulty.errors }}</div>
                        </div>
                        <div class="col-md-4">
                            {{ form.time_limit.label_tag }}
                            {{ form.time_limit }}
                            <div class="invalid-feedback">{{ form.time_limit.errors }}</div>
                        </div>
                        <div class="col-md-6">
                            {{ form.due_date.label_tag }}
                            {{ form.due_date }}
                            <div class="invalid-feedback">{{ form.due_date.errors }}</div>
                        </div>
                        <div class="col-md-6">
                            {{ form.topic.label_tag }}
                            {{ form.topic }}
                            <div class="invalid-feedback">{{ form.topic.errors }}</div>
                        </div>
                        <div class="col-12">
                            {{ form.explanation.label_tag }}
                            {{ form.explanation }}
                            <div class="invalid-feedback">{{ form.explanation.errors }}</div>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <h4>Options</h4>
                        <div id="optionsContainer" class="mb-3">
                            <!-- Options will be added here -->
                        </div>
                        <button type="button" id="addOptionBtn" class="btn btn-outline-primary">
                            <i class="fas fa-plus"></i> Add Option
                        </button>
                        <div id="optionsError" class="text-danger mt-2"></div>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <a href="#" class="btn btn-secondary">
                            Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            Create Assessment
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</main>


<script>
    document.getElementById('id_course').addEventListener('change', function() {
        const courseId = this.value;
        fetch(`ajax/load-topics/?course_id=${courseId}`)
            .then(response => response.json())
            .then(data => {
                const topicSelect = document.getElementById('id_topic');
                topicSelect.innerHTML = '<option value="">Select Topic</option>';
                data.forEach(topic => {
                    topicSelect.innerHTML += `<option value="${topic.id}">${topic.name}</option>`;
                });
            });
    });
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const optionsContainer = document.getElementById('optionsContainer');
    const addOptionBtn = document.getElementById('addOptionBtn');
    const form = document.getElementById('assessmentForm');
    const optionsError = document.getElementById('optionsError');
    let optionCount = 0;
    
    // Add initial options
    addOption();
    addOption();
    
    // Add option button handler
    addOptionBtn.addEventListener('click', addOption);
    
    // Form submission handler
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        submitForm();
    });
    
    function addOption() {
        if (optionCount >= 6) {
            alert('Maximum 6 options allowed');
            return;
        }
        
        optionCount++;
        const optionId = `option_${optionCount}`;
        
        const optionHtml = `
        <div class="card mb-3 option-item" id="${optionId}">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <label class="form-label">Option Text</label>
                        <textarea class="form-control option-text" name="options[][text]" rows="2" required></textarea>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check form-switch pt-3">
                            <input class="form-check-input is-correct-checkbox" type="checkbox" 
                                   name="options[][is_correct]" value="true">
                            <label class="form-check-label">Correct Answer</label>
                        </div>
                    </div>
                    <div class="col-md-1 text-end">
                        <button type="button" class="btn btn-sm btn-danger remove-option" 
                                data-option-id="${optionId}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        `;
        
        optionsContainer.insertAdjacentHTML('beforeend', optionHtml);
        
        // Add remove handler
        document.querySelector(`[data-option-id="${optionId}"]`).addEventListener('click', function() {
            if (optionCount <= 2) {
                alert('At least 2 options are required');
                return;
            }
            document.getElementById(optionId).remove();
            optionCount--;
        });
    }
    
    function submitForm() {
        const formData = new FormData(form);
        
        // Validate options
        const optionTexts = document.querySelectorAll('.option-text');
        if (optionTexts.length < 2) {
            optionsError.textContent = 'At least 2 options are required';
            return;
        }
        
        let hasCorrect = false;
        document.querySelectorAll('.is-correct-checkbox').forEach(cb => {
            if (cb.checked) hasCorrect = true;
        });
        
        if (!hasCorrect) {
            optionsError.textContent = 'At least one option must be marked correct';
            return;
        }
        
        optionsError.textContent = '';
        
        // Submit via AJAX
        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw err; });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                window.location.href = data.redirect_url;
            } else {
                // Handle form errors
                if (data.errors) {
                    Object.entries(data.errors).forEach(([field, errors]) => {
                        const input = form.querySelector(`[name="${field}"]`);
                        if (input) {
                            input.classList.add('is-invalid');
                            const errorDiv = document.createElement('div');
                            errorDiv.className = 'invalid-feedback';
                            errorDiv.textContent = errors[0].message;
                            input.closest('.form-group,.col-md-12,.col-md-4,.col-md-6').appendChild(errorDiv);
                        }
                    });
                }
                if (data.message) {
                    optionsError.textContent = data.message;
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            optionsError.textContent = 'An error occurred. Please try again.';
        });
    }
});
</script>
{% endblock %}